<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bahen Prayer Room — Iqama Reminder</title>
  <style>
    /* ── Variables ──────────────────────────────────────────── */
    :root {
      --bg: #f8f9fa;
      --bg-image: none;
      --text: #1a1a2e;
      --muted: #6c757d;
      --accent: #1a1a2e;
      --accent-dark: #0f0f1a;
      --accent-light: #eeeef2;
      --border: #dee2e6;
      --radius: 14px;
      --warn: #e67e22;
      --danger: #c0392b;
    }

    /* ── Reset & Base ──────────────────────────────────────── */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      position: relative;
      z-index: 0;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-color: var(--bg);
      background-image: var(--bg-image);
      background-position: center top;
      background-size: cover;
      background-repeat: no-repeat;
      background-attachment: fixed;
      filter: grayscale(100%);
      z-index: -1;
      pointer-events: none;
    }

    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    /* ── Glass panel (shared by header, cards, footer, disclaimer) */
    .glass {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
    }

    /* ── Header ────────────────────────────────────────────── */
    header {
      text-align: center;
      padding: 28px 24px 16px;
      margin-bottom: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    }

    header h1 {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--accent);
    }

    .subtitle {
      color: var(--muted);
      font-size: 0.9rem;
      margin-top: 4px;
    }

    .location-link {
      display: inline-block;
      margin-top: 6px;
      font-size: 0.85rem;
      color: var(--accent);
      text-decoration: none;
      border-bottom: 1px dashed var(--accent);
    }

    .location-link:hover {
      border-bottom-style: solid;
    }

    /* ── Cards ──────────────────────────────────────────────── */
    .card {
      border: 1px solid var(--border);
      padding: 20px;
      margin: 16px 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .card h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--accent);
    }

    /* ── Buttons ────────────────────────────────────────────── */
    button {
      padding: 10px 20px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-primary            { background: var(--accent); color: #fff; }
    .btn-primary:hover      { background: var(--accent-dark); }
    .btn-secondary          { background: #f1f3f5; color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover    { background: #e9ecef; }
    .btn-warn               { background: var(--warn); color: #fff; }
    .btn-warn:hover         { background: #cf6d17; }
    .btn-link               { display: inline-block; margin-top: 14px; padding: 10px 20px;
                              background: var(--accent); color: #fff; border-radius: 10px;
                              text-decoration: none; font-weight: 600; font-size: 0.9rem; }
    .btn-link:hover         { background: var(--accent-dark); }

    /* ── Controls card ─────────────────────────────────────── */
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
      font-size: 0.9rem;
    }

    .toggle-row label { cursor: pointer; user-select: none; }

    /* Audio mode selector */
    .audio-mode { margin-top: 12px; }
    .mode-options { display: flex; gap: 8px; flex-wrap: wrap; }
    .mode-option {
      cursor: pointer; display: flex; align-items: center; gap: 6px;
      padding: 8px 16px; border-radius: 10px; border: 1px solid var(--border);
      font-size: 0.88rem; font-weight: 600; transition: all 0.2s; user-select: none;
    }
    .mode-option:hover { background: #f1f3f5; }
    .mode-option input { display: none; }
    .mode-option:has(input:checked) {
      background: var(--accent); color: #fff; border-color: var(--accent);
    }

    /* Volume slider */
    .volume-row {
      display: flex; align-items: center; gap: 10px;
      margin-top: 12px; font-size: 0.85rem; color: var(--muted);
    }
    .volume-row label { flex-shrink: 0; font-weight: 600; }
    .volume-row input[type="range"] {
      flex: 1; height: 6px; -webkit-appearance: none; appearance: none;
      background: var(--border); border-radius: 3px; outline: none;
    }
    .volume-row input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 18px; height: 18px;
      background: var(--accent); border-radius: 50%; cursor: pointer;
    }
    .volume-row input[type="range"]::-moz-range-thumb {
      width: 18px; height: 18px; background: var(--accent);
      border-radius: 50%; border: none; cursor: pointer;
    }
    .volume-pct { min-width: 32px; text-align: right; }

    #status    { color: var(--muted); font-size: 0.9rem; margin-top: 12px; }
    #nextLine  { font-size: 0.95rem; font-weight: 500; margin-top: 6px; min-height: 1.4em; }

    /* Snooze bar */
    #snoozeBar {
      display: none; margin-top: 12px; padding: 12px 16px;
      background: #fff3e0; border-radius: 10px; border: 1px solid var(--warn);
      align-items: center; gap: 10px; flex-wrap: wrap;
    }
    #snoozeBar.visible        { display: flex; }
    #snoozeBar .snooze-text   { flex: 1; font-weight: 600; font-size: 0.95rem; min-width: 120px; }

    /* ── Countdown ──────────────────────────────────────────── */
    .countdown {
      text-align: center; padding: 16px; border-radius: 12px;
      margin-bottom: 14px; transition: background 0.5s, color 0.5s;
      background: #e8f5e9; color: #1a1a2e;
    }
    .countdown-label { font-size: 0.85rem; font-weight: 600; opacity: 0.8; }
    .countdown-timer { font-size: 2rem; font-weight: 800; letter-spacing: 0.05em; font-variant-numeric: tabular-nums; }
    .countdown.far     { background: #e8f5e9; color: #1a1a2e; }   /* > 30 min — green */
    .countdown.medium  { background: #fff3e0; color: #e65100; }   /* 10–30 min — orange */
    .countdown.soon    { background: #ffebee; color: #b71c1c; }   /* < 10 min — red */
    .countdown.now     { background: #b71c1c; color: #fff; animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }

    /* ── Table ──────────────────────────────────────────────── */
    table        { width: 100%; border-collapse: collapse; }
    th           { padding: 8px 8px 10px; text-align: left; font-size: 0.8rem;
                   color: var(--muted); font-weight: 600; text-transform: uppercase;
                   letter-spacing: 0.03em; border-bottom: 2px solid var(--border); }
    td           { padding: 10px 8px; border-bottom: 1px solid #f0f0f0; font-size: 0.95rem; }
    td:first-child          { font-weight: 600; width: 34%; }
    tbody tr:last-child td   { border-bottom: none; }

    /* ── Helpers ────────────────────────────────────────────── */
    .ok         { color: var(--accent); font-weight: 700; }
    .bad        { color: var(--danger); font-weight: 700; }
    .muted      { color: var(--muted); font-size: 0.82rem; margin-top: 8px; }
    .last-updated { color: var(--muted); font-size: 0.78rem; margin-top: 4px; font-style: italic; }

    /* ── Content blocks (aya / hadith) ─────────────────────── */
    .content-block {
      padding: 12px 16px;
      background: var(--accent-light);
      border-radius: 10px;
      border-left: 4px solid var(--accent);
    }
    .content-block b { display: block; margin-bottom: 4px; }

    /* ── Facilities list ───────────────────────────────────── */
    .facility-list {
      list-style: none;
      padding-left: 0;
      font-size: 0.9rem;
    }
    .facility-list li { margin-bottom: 6px; padding-left: 20px; position: relative; }
    .facility-list li::before {
      content: "\25CF"; color: var(--accent); position: absolute; left: 0;
    }
    .facility-list li:last-child { margin-bottom: 0; }

    /* ── How-to-use list ───────────────────────────────────── */
    .how-to-list {
      font-size: 0.9rem;
      padding-left: 20px;
    }
    .how-to-list li { margin-bottom: 6px; }
    .how-to-list li:last-child { margin-bottom: 0; }
    .test-btn-row { margin-top: 12px; }

    /* ── Image slider ──────────────────────────────────────── */
    .slider-wrap                { position: relative; margin-top: 12px; border-radius: 10px; overflow: hidden; }
    .slider-wrap img            { width: 100%; display: none; border-radius: 10px; }
    .slider-wrap img.active     { display: block; }

    .slider-badge {
      position: absolute; top: 8px; left: 8px; min-width: 28px; height: 28px;
      padding: 0 8px; background: var(--accent); color: #fff; border-radius: 14px;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.8rem; font-weight: 700; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
    }

    .slider-controls {
      display: flex; justify-content: center; align-items: center;
      gap: 14px; margin-top: 10px;
    }
    .slider-controls button {
      width: 36px; height: 36px; padding: 0; border-radius: 50%;
      background: var(--accent); color: #fff; font-size: 1.1rem;
      line-height: 1; display: flex; align-items: center; justify-content: center;
    }
    .slider-controls button:hover { background: var(--accent-dark); }

    .slider-counter {
      font-size: 0.85rem; color: var(--muted); font-weight: 600;
      min-width: 40px; text-align: center;
    }

    /* ── Disclaimer ────────────────────────────────────────── */
    .disclaimer {
      text-align: center; color: var(--muted); font-size: 0.72rem;
      margin-top: 24px; padding: 10px 16px; line-height: 1.5;
    }
    .disclaimer a { color: var(--accent); }

    /* ── Footer ────────────────────────────────────────────── */
    footer {
      text-align: center; color: var(--muted); font-size: 0.8rem;
      margin-top: 12px; padding: 10px 16px;
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- Header -->
    <header class="glass">
      <h1>Bahen Prayer Room</h1>
      <div class="subtitle">Iqama Reminder &middot; Toronto</div>
      <a id="locationLink" class="location-link" target="_blank" rel="noopener"></a>
    </header>

    <!-- Controls -->
    <div class="card glass">
      <div class="controls">
        <button class="btn-primary" id="enableBtn">Enable Audio &amp; Start</button>
        <button class="btn-secondary" id="stopBtn">Stop</button>
      </div>
      <div class="audio-mode">
        <label class="muted" style="font-weight:600;margin-bottom:6px;display:block;">Notification sound:</label>
        <div class="mode-options">
          <label class="mode-option"><input type="radio" name="audioMode" value="adhan" /><span>Adhan</span></label>
          <label class="mode-option"><input type="radio" name="audioMode" value="iqama" checked /><span>Iqama</span></label>
          <label class="mode-option"><input type="radio" name="audioMode" value="short" /><span>Short</span></label>
        </div>
      </div>
      <div class="volume-row">
        <label for="volumeSlider">Volume</label>
        <input type="range" id="volumeSlider" min="0" max="100" value="80" />
        <span class="volume-pct" id="volumePct">80%</span>
      </div>
      <div class="controls" style="margin-top:12px;">
        <button class="btn-secondary" id="testAdhanBtn">&#9835; Test Adhan</button>
        <button class="btn-secondary" id="testIqamaBtn">&#9835; Test Iqama</button>
        <button class="btn-secondary" id="testShortBtn">&#9835; Test Short</button>
      </div>
      <p id="status">Not running.</p>
      <p id="nextLine"></p>
      <div id="snoozeBar">
        <span class="snooze-text" id="snoozeText">Playing...</span>
        <button class="btn-warn" id="snoozeBtn">Skip</button>
      </div>
    </div>

    <!-- Prayer Times -->
    <div class="card glass">
      <h3>Prayer Times (Toronto Time)</h3>
      <p class="muted" id="todayDate" style="margin-top:-6px;margin-bottom:4px;"></p>
      <p class="muted" id="currentTime" style="margin-bottom:10px;font-weight:600;"></p>

      <!-- Countdown to next iqama -->
      <div class="countdown" id="countdownBox">
        <div class="countdown-label" id="countdownLabel">Next iqama</div>
        <div class="countdown-timer" id="countdownTimer">--:--:--</div>
      </div>

      <table>
        <thead><tr><th>Prayer</th><th>Adhan</th><th>Iqama</th></tr></thead>
        <tbody id="timesBody"></tbody>
      </table>
      <p class="muted" id="adhanSource"></p>
      <p class="last-updated" id="lastUpdated"></p>
    </div>

    <!-- Facilities -->
    <div class="card glass">
      <h3>Facilities</h3>
      <ul class="facility-list">
        <li>Washroom available</li>
        <li>Sisters' prayer area available</li>
      </ul>
    </div>

    <!-- How to Use -->
    <div class="card glass">
      <h3>How to Use</h3>
      <ol class="how-to-list">
        <li><strong>Tap "Enable Audio &amp; Start"</strong> above &mdash; this unlocks sound in your browser and starts the reminder.</li>
        <li><strong>Keep this tab open</strong> &mdash; the reminder runs in the background as long as the tab stays open.</li>
        <li>When it's iqama time, the audio will play automatically. Use the <strong>Skip</strong> button to stop it early.</li>
        <li>Toggle <strong>"Short notification"</strong> if you prefer a brief alert instead of the full iqama audio.</li>
        <li>Tap <strong>"Stop"</strong> to disable the reminder at any time.</li>
      </ol>
      <p class="muted">Use the volume slider and test buttons in the controls above to preview sounds.</p>
    </div>

    <!-- Aya of the Day -->
    <div class="card glass">
      <h3>Aya of the Day</h3>
      <div id="ayaBox" class="content-block"></div>
    </div>

    <!-- Hadith of the Day -->
    <div class="card glass">
      <h3>Hadith of the Day</h3>
      <div id="hadithBox" class="content-block"></div>
    </div>

    <!-- How to Reach the Room -->
    <div class="card glass">
      <h3>How to Reach the Room</h3>
      <div class="slider-wrap" id="dirSlider"></div>
      <div class="slider-controls">
        <button id="sliderPrev">&#8592;</button>
        <span class="slider-counter" id="sliderCounter"></span>
        <button id="sliderNext">&#8594;</button>
      </div>
    </div>

    <!-- Community -->
    <div class="card glass">
      <h3>Community</h3>
      <p style="font-size:0.9rem;margin-bottom:10px;">
        Join the Bahen prayer room WhatsApp group for updates and coordination:
      </p>
      <a class="btn-link" href="https://chat.whatsapp.com/GOUYq2Cd9JF0cpgzlvMawc" target="_blank" rel="noopener">
        Join WhatsApp Group
      </a>
      <p class="muted">This website is not officially affiliated with the WhatsApp group.</p>
    </div>

    <!-- Open Source & Disclaimer -->
    <div class="disclaimer glass">
      <strong>Beta &amp; Open Source</strong> &mdash;
      This project is open source on
      <a href="https://github.com/MoH-assan/bahen_prayer_room" target="_blank" rel="noopener">GitHub</a>.
      Suggestions and contributions are welcome via
      <a href="https://github.com/MoH-assan/bahen_prayer_room/issues" target="_blank" rel="noopener">issues</a>,
      <a href="https://github.com/MoH-assan/bahen_prayer_room/pulls" target="_blank" rel="noopener">pull requests</a>,
      or email <a href="mailto:m.abobaker@live.com">m.abobaker@live.com</a>.
      <br><br>
      This page is <strong>not official</strong>. It is not affiliated with, endorsed by, or
      representative of the MSA, the University of Toronto, the WhatsApp community, or any official university body.
    </div>

    <footer class="glass">
      Bahen Prayer Room &middot; University of Toronto
    </footer>
  </div>

  <audio id="adhan" preload="auto"></audio>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="./config.js"></script>

  <script>
  (function () {
    "use strict";
    const { DateTime } = luxon;

    // ── Config shortcuts ──────────────────────────────────────
    const ZONE            = CONFIG.timezone;
    const IQAMA_TIMES     = { ...CONFIG.iqamaTimes };
    const AUDIO           = CONFIG.audio;
    const AYA             = CONFIG.dailyAya;
    const HADITH          = CONFIG.dailyHadith;
    const GRACE_SEC       = CONFIG.lateGraceSeconds;
    const MAGHRIB_OFFSET  = CONFIG.maghribOffsetMinutes || 5;
    const API             = CONFIG.adhanApi || {};
    const PRAYER_ORDER    = ["Fajr", "Dhuhr", "Asr", "Maghrib", "Isha"];

    let adhanTimes = {};

    // ── DOM ───────────────────────────────────────────────────
    const $ = id => document.getElementById(id);
    const enableBtn   = $("enableBtn");
    const stopBtn     = $("stopBtn");
    const modeRadios = document.querySelectorAll('input[name="audioMode"]');
    const statusEl    = $("status");
    const nextLineEl  = $("nextLine");
    const timesBody   = $("timesBody");
    const lastUpdEl   = $("lastUpdated");
    const adhanSrcEl  = $("adhanSource");
    const ayaBox      = $("ayaBox");
    const hadithBox   = $("hadithBox");
    const audioEl     = $("adhan");
    const locationEl  = $("locationLink");
    const snoozeBar   = $("snoozeBar");
    const snoozeText  = $("snoozeText");
    const snoozeBtn   = $("snoozeBtn");

    let running = false, nextEvent = null, timeoutId = null, watchdogId = null;

    // ── Helpers ───────────────────────────────────────────────
    const now   = () => DateTime.now().setZone(ZONE);
    const fmt   = dt => dt.toFormat("yyyy-LL-dd HH:mm:ss");

    function parseHHMM(s) {
      const [h, m] = s.split(":").map(Number);
      return { h, m };
    }

    function addMinutes(hhmm, mins) {
      const { h, m } = parseHHMM(hhmm);
      return DateTime.fromObject({ hour: h, minute: m }, { zone: ZONE })
        .plus({ minutes: mins }).toFormat("HH:mm");
    }

    // ── Short-mode toggle ─────────────────────────────────────
    // ── Audio mode persistence ──────────────────────────────
    function getAudioMode() {
      const checked = document.querySelector('input[name="audioMode"]:checked');
      return checked ? checked.value : "iqama";
    }

    function setAudioMode(mode) {
      const radio = document.querySelector(`input[name="audioMode"][value="${mode}"]`);
      if (radio) radio.checked = true;
    }

    // Restore saved mode
    const savedMode = localStorage.getItem("iqama_audio_mode") || "iqama";
    setAudioMode(savedMode);

    modeRadios.forEach(r => r.addEventListener("change", () => {
      localStorage.setItem("iqama_audio_mode", getAudioMode());
    }));

    // ── Fetch ISNA adhan times ────────────────────────────────
    async function fetchAdhanTimes() {
      try {
        const d    = now();
        const url  = `https://api.aladhan.com/v1/timingsByCity/${d.toFormat("dd-LL-yyyy")}` +
                     `?city=${encodeURIComponent(API.city || "Toronto")}` +
                     `&country=${encodeURIComponent(API.country || "Canada")}` +
                     `&method=${API.method || 2}`;
        const json = await (await fetch(url)).json();

        if (json.code === 200 && json.data?.timings) {
          const t = json.data.timings;
          const clean = s => (s || "").replace(/ \(.*\)/, "");
          adhanTimes = {
            Fajr: clean(t.Fajr), Dhuhr: clean(t.Dhuhr), Asr: clean(t.Asr),
            Maghrib: clean(t.Maghrib), Isha: clean(t.Isha),
          };
          if (adhanTimes.Maghrib) {
            IQAMA_TIMES.Maghrib = addMinutes(adhanTimes.Maghrib, MAGHRIB_OFFSET);
          }
          // Display today's Gregorian and Hijri dates
          const greg  = json.data.date?.gregorian;
          const hijri = json.data.date?.hijri;
          if (greg && hijri) {
            const gregStr  = `${greg.weekday.en}, ${greg.month.en} ${greg.day}, ${greg.year}`;
            const hijriStr = `${hijri.day} ${hijri.month.en} ${hijri.year} AH`;
            $("todayDate").innerHTML = `${gregStr} &mdash; ${hijriStr}`;
          }
          adhanSrcEl.textContent = "Adhan times: ISNA method via AlAdhan.com";
          return;
        }
      } catch (e) { console.warn("Adhan API error:", e); }

      adhanSrcEl.textContent = "Adhan times unavailable (API error)";
      $("todayDate").textContent = now().toFormat("EEEE, LLLL d, yyyy");
      if (!IQAMA_TIMES.Maghrib) IQAMA_TIMES.Maghrib = "18:15";
    }

    // ── Build UI ──────────────────────────────────────────────
    function buildTimesTable() {
      timesBody.innerHTML = "";
      PRAYER_ORDER.forEach(name => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${name}</td><td>${adhanTimes[name] || "—"}</td><td>${IQAMA_TIMES[name] || "—"}</td>`;
        timesBody.appendChild(tr);
      });
    }

    function setLocation() {
      const loc = CONFIG.location;
      if (loc?.name) { locationEl.textContent = loc.name; locationEl.href = loc.mapsUrl || "#"; }
      else           { locationEl.style.display = "none"; }
    }

    function setDailyContent() {
      const d   = now().toFormat("yyyy-LL-dd");
      const aya = AYA[d]    || AYA["default"];
      const had = HADITH[d] || HADITH["default"];
      ayaBox.innerHTML    = `<b>${aya.ref}</b><div>${aya.text}</div>`;
      hadithBox.innerHTML = `<b>${had.ref}</b><div>${had.text}</div>`;
    }

    // ── Audio ─────────────────────────────────────────────────
    function audioSrc(prayer) {
      const mode = getAudioMode();
      if (mode === "short") return AUDIO.short || "./short.mp3";
      if (mode === "adhan")  return AUDIO.adhan || "./adhan.mp3";
      return AUDIO.iqama || "./eqamah.mp3";
    }

    async function play(prayer) {
      const src = audioSrc(prayer);
      if (audioEl.src !== new URL(src, location.href).href) audioEl.src = src;
      audioEl.currentTime = 0;
      await audioEl.play();
    }

    function stopAudio() { audioEl.pause(); audioEl.currentTime = 0; hideSnooze(); }

    // ── Snooze bar ────────────────────────────────────────────
    function showSnooze(name) { snoozeText.textContent = `Playing ${name}...`; snoozeBar.classList.add("visible"); }
    function hideSnooze()     { snoozeBar.classList.remove("visible"); }

    snoozeBtn.addEventListener("click", () => { stopAudio(); statusEl.innerHTML = `Skipped <span class="ok">&#10003;</span>`; });
    audioEl.addEventListener("ended", hideSnooze);

    // ── Scheduling ────────────────────────────────────────────
    function clearTimers() {
      if (timeoutId)  { clearTimeout(timeoutId);  timeoutId  = null; }
      if (watchdogId) { clearInterval(watchdogId); watchdogId = null; }
    }

    function computeNext() {
      const n = now();
      const list = Object.entries(IQAMA_TIMES)
        .filter(([k]) => PRAYER_ORDER.includes(k))
        .map(([name, hhmm]) => {
          const { h, m } = parseHHMM(hhmm);
          let dt = n.set({ hour: h, minute: m, second: 0, millisecond: 0 });
          if (dt <= n) dt = dt.plus({ days: 1 });
          return { name, dt };
        });
      list.sort((a, b) => a.dt.toMillis() - b.dt.toMillis());
      return { ...list[0], fired: false };
    }

    // ── Clock & Countdown ──────────────────────────────────
    const countdownBox   = $("countdownBox");
    const countdownLabel = $("countdownLabel");
    const countdownTimer = $("countdownTimer");
    const currentTimeEl  = $("currentTime");

    function updateClock() {
      currentTimeEl.textContent = now().toFormat("hh:mm:ss a");
    }

    function updateCountdown() {
      // Always compute next iqama for countdown (even if not "running")
      const n = now();
      const next = Object.entries(IQAMA_TIMES)
        .filter(([k]) => PRAYER_ORDER.includes(k))
        .map(([name, hhmm]) => {
          const { h, m } = parseHHMM(hhmm);
          let dt = n.set({ hour: h, minute: m, second: 0, millisecond: 0 });
          if (dt <= n) dt = dt.plus({ days: 1 });
          return { name, dt };
        })
        .sort((a, b) => a.dt.toMillis() - b.dt.toMillis())[0];

      if (!next) return;

      const totalSec = Math.max(0, Math.floor((next.dt.toMillis() - n.toMillis()) / 1000));
      const hh = String(Math.floor(totalSec / 3600)).padStart(2, "0");
      const mm = String(Math.floor((totalSec % 3600) / 60)).padStart(2, "0");
      const ss = String(totalSec % 60).padStart(2, "0");
      const totalMin = totalSec / 60;

      countdownLabel.textContent = `Next: ${next.name} at ${next.dt.toFormat("h:mm a")}`;
      countdownTimer.textContent = `${hh}:${mm}:${ss}`;

      // Color based on proximity
      countdownBox.classList.remove("far", "medium", "soon", "now");
      if (totalSec <= 0)         countdownBox.classList.add("now");
      else if (totalMin <= 10)   countdownBox.classList.add("soon");
      else if (totalMin <= 30)   countdownBox.classList.add("medium");
      else                       countdownBox.classList.add("far");
    }

    // Tick every second for clock + countdown
    setInterval(() => { updateClock(); updateCountdown(); }, 1000);
    updateClock();

    function updateUI() {
      if (!running) { statusEl.innerHTML = "Not running."; nextLineEl.textContent = ""; return; }
      statusEl.innerHTML = `Running <span class="ok">&#9679;</span> &nbsp;(keep this tab open)`;
      if (nextEvent) {
        const s  = Math.max(0, Math.floor((nextEvent.dt.toMillis() - now().toMillis()) / 1000));
        const hh = String(Math.floor(s / 3600)).padStart(2, "0");
        const mm = String(Math.floor((s % 3600) / 60)).padStart(2, "0");
        const ss = String(s % 60).padStart(2, "0");
        nextLineEl.textContent = `Next: ${nextEvent.name} at ${fmt(nextEvent.dt)} (${ZONE})  |  in ${hh}:${mm}:${ss}`;
      }
    }

    async function triggerIfDue() {
      if (!running || !nextEvent || nextEvent.fired) return;
      const diff = (now().toMillis() - nextEvent.dt.toMillis()) / 1000;
      if (diff >= 0 && diff <= GRACE_SEC) {
        nextEvent.fired = true;
        try {
          await play(nextEvent.name);
          showSnooze(nextEvent.name);
          statusEl.innerHTML = `Playing <b>${nextEvent.name}</b> <span class="ok">&#10003;</span>`;
        } catch {
          statusEl.innerHTML = `Audio blocked <span class="bad">&#10008;</span> — tap "Enable Audio & Start" again.`;
        } finally { scheduleNext(); }
      }
    }

    function scheduleNext() {
      clearTimers();
      nextEvent = computeNext();
      updateUI();
      const ms = Math.max(0, nextEvent.dt.toMillis() - now().toMillis());
      timeoutId  = setTimeout(triggerIfDue, ms);
      watchdogId = setInterval(() => { updateUI(); triggerIfDue(); }, 1000);
    }

    function start() { running = true; localStorage.setItem("iqama_reminder_enabled", "1"); scheduleNext(); }
    function stop()  { running = false; nextEvent = null; clearTimers(); stopAudio(); localStorage.removeItem("iqama_reminder_enabled"); updateUI(); }

    // ── Volume ─────────────────────────────────────────────────
    const volumeSlider = $("volumeSlider");
    const volumePct    = $("volumePct");

    // Restore saved volume
    const savedVol = localStorage.getItem("iqama_volume");
    if (savedVol !== null) { volumeSlider.value = savedVol; }
    audioEl.volume = volumeSlider.value / 100;
    volumePct.textContent = volumeSlider.value + "%";

    volumeSlider.addEventListener("input", () => {
      const v = volumeSlider.value;
      audioEl.volume = v / 100;
      volumePct.textContent = v + "%";
      localStorage.setItem("iqama_volume", v);
    });

    // ── Events ────────────────────────────────────────────────
    enableBtn.addEventListener("click", async () => {
      try { await play("default"); audioEl.pause(); audioEl.currentTime = 0; } catch {}
      start();
    });
    stopBtn.addEventListener("click", stop);

    async function testAudio(src, label) {
      audioEl.src = src;
      audioEl.currentTime = 0;
      try { await audioEl.play(); showSnooze(label); } catch {}
    }
    $("testAdhanBtn").addEventListener("click", () => testAudio(AUDIO.adhan || "./adhan.mp3", "Adhan test"));
    $("testIqamaBtn").addEventListener("click", () => testAudio(AUDIO.iqama || "./eqamah.mp3", "Iqama test"));
    $("testShortBtn").addEventListener("click", () => testAudio(AUDIO.short || "./short.mp3", "Short test"));

    // ── Background ────────────────────────────────────────────
    (function () {
      const bgs = CONFIG.backgrounds || [];
      if (bgs.length) {
        const selectedBg = bgs[Math.floor(Math.random() * bgs.length)];
        document.body.style.setProperty("--bg-image", `url("${selectedBg}")`);
      }
    })();

    // ── Directions slider ─────────────────────────────────────
    (function () {
      const images = CONFIG.directionImages || [];
      const wrap   = $("dirSlider");
      const ctr    = $("sliderCounter");
      if (!images.length) return;

      images.forEach((src, i) => {
        const div   = document.createElement("div");
        div.style.position = "relative";
        const img   = document.createElement("img");
        img.src = src; img.alt = `Step ${i + 1}`;
        if (i === 0) img.classList.add("active");
        const badge = document.createElement("span");
        badge.className = "slider-badge";
        badge.textContent = `${i + 1} / ${images.length}`;
        div.append(img, badge);
        wrap.appendChild(div);
      });

      const allImgs = wrap.querySelectorAll("img");
      const total   = allImgs.length;
      let idx = 0;

      function show(i) {
        allImgs.forEach((img, n) => img.classList.toggle("active", n === i));
        ctr.textContent = `${i + 1} / ${total}`;
        wrap.querySelectorAll(".slider-badge").forEach((b, n) => b.style.display = n === i ? "flex" : "none");
      }

      $("sliderPrev").addEventListener("click", () => { idx = (idx - 1 + total) % total; show(idx); });
      $("sliderNext").addEventListener("click", () => { idx = (idx + 1) % total; show(idx); });

      let startX = 0;
      wrap.addEventListener("touchstart", e => { startX = e.touches[0].clientX; }, { passive: true });
      wrap.addEventListener("touchend", e => {
        const d = e.changedTouches[0].clientX - startX;
        if (Math.abs(d) > 40) { idx = d < 0 ? (idx + 1) % total : (idx - 1 + total) % total; show(idx); }
      }, { passive: true });

      show(0);
    })();

    // ── Init ──────────────────────────────────────────────────
    (async function () {
      setLocation();
      setDailyContent();
      await fetchAdhanTimes();
      buildTimesTable();
      if (CONFIG.lastUpdated) lastUpdEl.textContent = `Iqama times last updated: ${CONFIG.lastUpdated}`;
      updateUI();

      if (localStorage.getItem("iqama_reminder_enabled") === "1") {
        running = true;
        scheduleNext();
        statusEl.innerHTML = `Running <span class="ok">&#9679;</span> &nbsp;(if sound doesn't play, tap Enable once)`;
      }
    })();
  })();
  </script>
</body>
</html>
